<!doctype html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
      <title>Star Notary DApp</title>
   </head>
   <body>
      <div class="container">
         <div class="py-5 text-center">
            <h2>Decentralized Star Notary DApp</h2>
            <p class="lead">
                This DApp lets users register a Star that, later on, can be used to prove authenticity when other user tries to register same Star.<br>
                This DApp is developed using Solidity to demonstrate how 'Smart Contracts' works. <br>
                Primarily, it is implemented using <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-721.md">ERC-721 Contract</a>
            </p>
         </div>
         <div class="row">
            <div class="col-md-7 order-md-1">
               <h4 class="mb-3">Claim star</h4>
               <div class="row">
                  <div class="col-md-6 mb-3">
                     <label for="star-name">Star Name</label>
                     <input type="text" class="form-control" id="star-name" placeholder="Star power 103" required="">
                     <div class="invalid-feedback">
                        Invalid Star Name
                     </div>
                  </div>
                  <div class="col-md-6 mb-3">
                     <label for="star-token">Token ID</label>
                     <input type="text" class="form-control" id="star-token" placeholder="Token ID" required="">
                     <div class="invalid-feedback">
                        Invalid Token ID
                     </div>
                  </div>
               </div>
               <div class="mb-3">
                  <label for="star-story">Star Story</label>
                  <input type="text" class="form-control" id="star-story" placeholder="I love my wonderful star" required="">
                  <div class="invalid-feedback">
                     Invalid
                  </div>
               </div>
               <div class="row">
                  <div class="col-md-4 mb-3">
                     <label for="star-ascension">Right Ascension</label>
                     <input type="text" class="form-control" id="star-ascension" placeholder="ra_032.155" required="">
                     <div class="invalid-feedback">
                        Invalid Star Right Ascension
                     </div>
                  </div>
                  <div class="col-md-4 mb-3">
                     <label for="star-declination">Declination</label>
                     <input type="text" class="form-control" id="star-declination" placeholder="dec_121.874" required="">
                     <div class="invalid-feedback">
                        Invalid Star Declination
                     </div>
                  </div>
                  <div class="col-md-4 mb-3">
                     <label for="star-magnitude">Magnitude</label>
                     <input type="text" class="form-control" id="star-magnitude" placeholder="mag_245.978" required="">
                     <div class="invalid-feedback">
                        Invalid Star Magnitude
                     </div>
                  </div>
               </div>
               <hr class="mb-4">
               <button class="btn btn-primary btn-lg btn-block" onclick="claimButtonClicked()">CLAIM</button>
            </div>
            <div class="col-md-5 order-md-2 mb-4">
              <h4 class="d-flex justify-content-between align-items-center mb-3">
                 <span class="text-muted">Search Star</span>
              </h4>
              <h6 class="d-flex justify-content-between align-items-center mb-3">
                 <span class="text-muted">Look star by ID</span>
              </h6>
              <div class="card p-2">
                 <div class="input-group">
                    <input type="text" class="form-control" id="star-token-search" placeholder="Token ID">
                    <div class="input-group-append">
                       <button type="submit" class="btn btn-primary" onclick="searchClicked()">SEARCH</button>
                    </div>
                 </div>
              </div>
              <hr class="mb-4">
              <h4 class="d-flex justify-content-between align-items-center mb-3">
                 <span class="text-muted">Sale Star</span>
              </h4>
              <h6 class="d-flex justify-content-between align-items-center mb-3">
                 <span class="text-muted">Put star up for sale</span>
              </h6>
              <div class="row">
               <div class="col-md-6 mb-3">
                    <label for="star-token-sale">Token ID</label>
                    <input type="text" class="form-control" id="star-token-sale" placeholder="Token ID" required="">
                    <div class="invalid-feedback">
                       Invalid Token ID
                    </div>
                 </div>
                 <div class="col-md-6 mb-3">
                    <label for="star-price-sale">Star Price</label>
                    <input type="text" class="form-control" id="star-price-sale" placeholder="Star price" required="">
                    <div class="invalid-feedback">
                       Invalid Star price
                    </div>
                 </div>
                 <div class="col-md-12 mb-3">
                    <button class="btn btn-primary btn-lg btn-block" onclick="saleClicked()">SALE</button>
                 </div>
              </div>
           </div>
         </div>
         <hr class="mb-4">
         <div class="row">
            <div class="col-md-12 mb-3">
                <h4 class="d-flex justify-content-between align-items-center mb-3">Response:</h4>
                <h6 id="star-result"></h6>
            </div>
         </div>
      </div>

      <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
      <script>
        if (window.ethereum) {
            window.web3 = new Web3(ethereum);
            try {
                ethereum.enable().then(console.log('enabled'))
            }
            catch(error) {
                console.log('Use account access not allowed');
            }
        }
        else if (window.web3) {
            window.web3 = new Web3(ethereum);
        }

        //
        // The interface definition for your smart contract (the ABI)
        //
        var StarNotary = web3.eth.contract([
                                  {
                                "constant": true,
                                "inputs": [
                                  {
                                    "name": "interfaceId",
                                    "type": "bytes4"
                                  }
                                ],
                                "name": "supportsInterface",
                                "outputs": [
                                  {
                                    "name": "",
                                    "type": "bool"
                                  }
                                ],
                                "payable": false,
                                "stateMutability": "view",
                                "type": "function",
                                "signature": "0x01ffc9a7"
                              },
                              {
                                "constant": true,
                                "inputs": [
                                  {
                                    "name": "",
                                    "type": "uint256"
                                  }
                                ],
                                "name": "starsForSale",
                                "outputs": [
                                  {
                                    "name": "",
                                    "type": "uint256"
                                  }
                                ],
                                "payable": false,
                                "stateMutability": "view",
                                "type": "function",
                                "signature": "0x0564b130"
                              },
                              {
                                "constant": true,
                                "inputs": [
                                  {
                                    "name": "tokenId",
                                    "type": "uint256"
                                  }
                                ],
                                "name": "getApproved",
                                "outputs": [
                                  {
                                    "name": "",
                                    "type": "address"
                                  }
                                ],
                                "payable": false,
                                "stateMutability": "view",
                                "type": "function",
                                "signature": "0x081812fc"
                              },
                              {
                                "constant": false,
                                "inputs": [
                                  {
                                    "name": "to",
                                    "type": "address"
                                  },
                                  {
                                    "name": "tokenId",
                                    "type": "uint256"
                                  }
                                ],
                                "name": "approve",
                                "outputs": [],
                                "payable": false,
                                "stateMutability": "nonpayable",
                                "type": "function",
                                "signature": "0x095ea7b3"
                              },
                              {
                                "constant": true,
                                "inputs": [
                                  {
                                    "name": "",
                                    "type": "uint256"
                                  }
                                ],
                                "name": "tokenIdToStarInfo",
                                "outputs": [
                                  {
                                    "name": "name",
                                    "type": "string"
                                  },
                                  {
                                    "name": "story",
                                    "type": "string"
                                  },
                                  {
                                    "name": "coord_dec",
                                    "type": "string"
                                  },
                                  {
                                    "name": "coord_mag",
                                    "type": "string"
                                  },
                                  {
                                    "name": "coord_cent",
                                    "type": "string"
                                  }
                                ],
                                "payable": false,
                                "stateMutability": "view",
                                "type": "function",
                                "signature": "0x1967fd98"
                              },
                              {
                                "constant": false,
                                "inputs": [
                                  {
                                    "name": "from",
                                    "type": "address"
                                  },
                                  {
                                    "name": "to",
                                    "type": "address"
                                  },
                                  {
                                    "name": "tokenId",
                                    "type": "uint256"
                                  }
                                ],
                                "name": "transferFrom",
                                "outputs": [],
                                "payable": false,
                                "stateMutability": "nonpayable",
                                "type": "function",
                                "signature": "0x23b872dd"
                              },
                              {
                                "constant": false,
                                "inputs": [
                                  {
                                    "name": "from",
                                    "type": "address"
                                  },
                                  {
                                    "name": "to",
                                    "type": "address"
                                  },
                                  {
                                    "name": "tokenId",
                                    "type": "uint256"
                                  }
                                ],
                                "name": "safeTransferFrom",
                                "outputs": [],
                                "payable": false,
                                "stateMutability": "nonpayable",
                                "type": "function",
                                "signature": "0x42842e0e"
                              },
                              {
                                "constant": true,
                                "inputs": [
                                  {
                                    "name": "tokenId",
                                    "type": "uint256"
                                  }
                                ],
                                "name": "ownerOf",
                                "outputs": [
                                  {
                                    "name": "",
                                    "type": "address"
                                  }
                                ],
                                "payable": false,
                                "stateMutability": "view",
                                "type": "function",
                                "signature": "0x6352211e"
                              },
                              {
                                "constant": true,
                                "inputs": [
                                  {
                                    "name": "owner",
                                    "type": "address"
                                  }
                                ],
                                "name": "balanceOf",
                                "outputs": [
                                  {
                                    "name": "",
                                    "type": "uint256"
                                  }
                                ],
                                "payable": false,
                                "stateMutability": "view",
                                "type": "function",
                                "signature": "0x70a08231"
                              },
                              {
                                "constant": true,
                                "inputs": [
                                  {
                                    "name": "",
                                    "type": "bytes32"
                                  }
                                ],
                                "name": "existingStars",
                                "outputs": [
                                  {
                                    "name": "",
                                    "type": "uint256"
                                  }
                                ],
                                "payable": false,
                                "stateMutability": "view",
                                "type": "function",
                                "signature": "0x79aae6c3"
                              },
                              {
                                "constant": false,
                                "inputs": [
                                  {
                                    "name": "to",
                                    "type": "address"
                                  },
                                  {
                                    "name": "approved",
                                    "type": "bool"
                                  }
                                ],
                                "name": "setApprovalForAll",
                                "outputs": [],
                                "payable": false,
                                "stateMutability": "nonpayable",
                                "type": "function",
                                "signature": "0xa22cb465"
                              },
                              {
                                "constant": false,
                                "inputs": [
                                  {
                                    "name": "from",
                                    "type": "address"
                                  },
                                  {
                                    "name": "to",
                                    "type": "address"
                                  },
                                  {
                                    "name": "tokenId",
                                    "type": "uint256"
                                  },
                                  {
                                    "name": "_data",
                                    "type": "bytes"
                                  }
                                ],
                                "name": "safeTransferFrom",
                                "outputs": [],
                                "payable": false,
                                "stateMutability": "nonpayable",
                                "type": "function",
                                "signature": "0xb88d4fde"
                              },
                              {
                                "constant": true,
                                "inputs": [
                                  {
                                    "name": "owner",
                                    "type": "address"
                                  },
                                  {
                                    "name": "operator",
                                    "type": "address"
                                  }
                                ],
                                "name": "isApprovedForAll",
                                "outputs": [
                                  {
                                    "name": "",
                                    "type": "bool"
                                  }
                                ],
                                "payable": false,
                                "stateMutability": "view",
                                "type": "function",
                                "signature": "0xe985e9c5"
                              },
                              {
                                "anonymous": false,
                                "inputs": [
                                  {
                                    "indexed": true,
                                    "name": "from",
                                    "type": "address"
                                  },
                                  {
                                    "indexed": true,
                                    "name": "to",
                                    "type": "address"
                                  },
                                  {
                                    "indexed": true,
                                    "name": "tokenId",
                                    "type": "uint256"
                                  }
                                ],
                                "name": "Transfer",
                                "type": "event",
                                "signature": "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef"
                              },
                              {
                                "anonymous": false,
                                "inputs": [
                                  {
                                    "indexed": true,
                                    "name": "owner",
                                    "type": "address"
                                  },
                                  {
                                    "indexed": true,
                                    "name": "approved",
                                    "type": "address"
                                  },
                                  {
                                    "indexed": true,
                                    "name": "tokenId",
                                    "type": "uint256"
                                  }
                                ],
                                "name": "Approval",
                                "type": "event",
                                "signature": "0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925"
                              },
                              {
                                "anonymous": false,
                                "inputs": [
                                  {
                                    "indexed": true,
                                    "name": "owner",
                                    "type": "address"
                                  },
                                  {
                                    "indexed": true,
                                    "name": "operator",
                                    "type": "address"
                                  },
                                  {
                                    "indexed": false,
                                    "name": "approved",
                                    "type": "bool"
                                  }
                                ],
                                "name": "ApprovalForAll",
                                "type": "event",
                                "signature": "0x17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31"
                              },
                              {
                                "constant": false,
                                "inputs": [
                                  {
                                    "name": "_name",
                                    "type": "string"
                                  },
                                  {
                                    "name": "_starStory",
                                    "type": "string"
                                  },
                                  {
                                    "name": "_ra",
                                    "type": "string"
                                  },
                                  {
                                    "name": "_dec",
                                    "type": "string"
                                  },
                                  {
                                    "name": "_mag",
                                    "type": "string"
                                  },
                                  {
                                    "name": "_tokenId",
                                    "type": "uint256"
                                  }
                                ],
                                "name": "createStar",
                                "outputs": [],
                                "payable": false,
                                "stateMutability": "nonpayable",
                                "type": "function",
                                "signature": "0xb250ced0"
                              },
                              {
                                "constant": false,
                                "inputs": [
                                  {
                                    "name": "_tokenId",
                                    "type": "uint256"
                                  },
                                  {
                                    "name": "_price",
                                    "type": "uint256"
                                  }
                                ],
                                "name": "putStarUpForSale",
                                "outputs": [],
                                "payable": false,
                                "stateMutability": "nonpayable",
                                "type": "function",
                                "signature": "0x316a4361"
                              },
                              {
                                "constant": false,
                                "inputs": [
                                  {
                                    "name": "_tokenId",
                                    "type": "uint256"
                                  }
                                ],
                                "name": "buyStar",
                                "outputs": [],
                                "payable": true,
                                "stateMutability": "payable",
                                "type": "function",
                                "signature": "0x2f1c34ef"
                              },
                              {
                                "constant": true,
                                "inputs": [
                                  {
                                    "name": "_ra",
                                    "type": "string"
                                  },
                                  {
                                    "name": "_dec",
                                    "type": "string"
                                  },
                                  {
                                    "name": "_mag",
                                    "type": "string"
                                  }
                                ],
                                "name": "checkIfStarExist",
                                "outputs": [
                                  {
                                    "name": "",
                                    "type": "bool"
                                  }
                                ],
                                "payable": false,
                                "stateMutability": "view",
                                "type": "function",
                                "signature": "0x0384153d"
                              },
                              {
                                "constant": false,
                                "inputs": [
                                  {
                                    "name": "_tokenId",
                                    "type": "uint256"
                                  }
                                ],
                                "name": "mint",
                                "outputs": [],
                                "payable": false,
                                "stateMutability": "nonpayable",
                                "type": "function",
                                "signature": "0xa0712d68"
                              }
        ]);
        // Grab the contract at specified deployed address with the interface defined by the ABI
        var starNotary = StarNotary.at('0x992EAEa1843fea0a84EF3ecFA3fB21F9064a4eE4');

        function claimButtonClicked() {
            const name = document.getElementById('star-name').value;
            const story = document.getElementById('star-story').value;
            const ra = document.getElementById('star-ascension').value;
            const dec = document.getElementById('star-declination').value;
            const mag = document.getElementById('star-magnitude').value;
            const token = document.getElementById('star-token').value;

            if (name.length < 1 ||
                story.length < 1 ||
                ra.length < 1 ||
                dec.length < 1 ||
                mag.length < 1 ||
                token.length < 1) {
                  alert('Please fill all the fields to claim a star!');
                  return;
            }
            web3.eth.getAccounts(function(error, accounts) {
                if (error) {
                    document.getElementById('star-result').innerText = error.message;
                    console.log(error);
                    return;
                }
                console.log(accounts[0]);
                var account = accounts[0];
                starNotary.createStar(name, story, ra, dec, mag, token, {
                    from: account
                }, function(error, result) {
                    if (!error) {
                        document.getElementById('star-name').value = '';
                        document.getElementById('star-ascension').value = '';
                        document.getElementById('star-declination').value = '';
                        document.getElementById('star-magnitude').value = '';
                        document.getElementById('star-story').value = '';
                        document.getElementById('star-token').value = '';
                        document.getElementById('star-result').innerText = "Star claimed successfully!";
                    }
                    else {
                        document.getElementById('star-result').innerText = error.message;
                        console.log(error);
                    }
                });         
            })
        }

        function searchClicked() {
            const tokenSearch = document.getElementById('star-token-search').value;
            web3.eth.getAccounts(function(error, accounts) {
                if (error) {
                    console.log(error);
                    return;
                }
                starNotary.tokenIdToStarInfo(tokenSearch, function(error, result) {
                    if (!error) {
                        console.log(result);
                        document.getElementById("star-token-search").value = '';
                        document.getElementById("star-result").innerText = 'Star searched: '+ JSON.stringify(result);
                        console.log('Star found: ', result);
                    } else {
                        document.getElementById('star-result').innerText = error.message;
                        console.error('Error searchin the star', error);
                    }
                });
            })
        }
        function saleClicked() {         
            const tokenSale = document.getElementById('star-token-sale').value;
            const priceSale = document.getElementById('star-price-sale').value;

            console.log(tokenSale);
            console.log(priceSale);
         
            web3.eth.getAccounts(function(error, accounts) {
                if (error) {
                    console.log(error);
                    return;
                }
                var account = accounts[0]
                starNotary.putStarUpForSale(tokenSale, priceSale, {
                     from: account
                }, function(error, result) {
                    if (!error) {
                        console.log(result)
                        document.getElementById("star-token-sale").value = '';
                        document.getElementById("star-price-sale").value = '';
                        document.getElementById("star-result").innerText = 'Star put for sale: '+ result;
                        console.log('Star put for sale: ', result);
                    } else {
                        document.getElementById('star-result').innerText = error.message;
                        console.error('Error putting the star for sale', error);
                    }
                });
            })
        }
      </script>
   </body>
</html>